# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ VK ID 2.0

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ —Å—Ç–∞—Ä–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ VK OAuth (v1.x) –Ω–∞ –Ω–æ–≤—ã–π –ø–ª–∞–≥–∏–Ω VK ID (v2.0).

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (v1.x) | –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (v2.0) |
|--------|---------------------|---------------------|
| **–ü—Ä–æ–≤–∞–π–¥–µ—Ä** | VK OAuth (oauth.vk.com) | VK ID (id.vk.ru) |
| **–í–µ—Ä—Å–∏—è OAuth** | OAuth 2.0 | OAuth 2.1 —Å PKCE |
| **–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞** | `vkontakte` | `vkid` |
| **–ü—Ä–µ—Ñ–∏–∫—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫** | `vk_*` | `vkid_*` |
| **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç gem** | `omniauth-vkontakte` | –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (–±–µ–∑ gem) |
| **PKCE** | –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |

## –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

- [ ] **–°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- [ ] –ó–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–µ VK App ID –∏ –ó–∞—â–∏—â—ë–Ω–Ω—ã–π –∫–ª—é—á
- [ ] –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ VK: `UserAssociatedAccount.where(provider_name: 'vkontakte').count`
- [ ] –£–≤–µ–¥–æ–º–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è)

## –®–∞–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è VK

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://id.vk.com/about/business/go
2. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è VK
3. –û–±–Ω–æ–≤–∏—Ç–µ **Redirect URI**:
   ```
   https://–≤–∞—à-—Å–∞–π—Ç-discourse.com/auth/vkid/callback
   ```
   –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: `/vkid/` –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ `/vkontakte/`

4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ **PKCE –≤–∫–ª—é—á—ë–Ω** –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö OAuth
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫–æ—É–ø—ã –≤–∫–ª—é—á–∞—é—Ç: `vkid.personal_info`, `email`

### –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞

1. –ü–ª–∞–≥–∏–Ω –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ git. –ï—Å–ª–∏ –Ω–µ—Ç, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
   ```bash
   cd /var/discourse
   ./launcher enter app
   cd plugins/discourse-vk-auth
   git pull
   exit
   ```

2. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ Discourse:
   ```bash
   cd /var/discourse
   ./launcher rebuild app
   ```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ê–¥–º–∏–Ω** ‚Üí **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–í—Ö–æ–¥**
2. –ù–∞–π–¥–∏—Ç–µ "VK ID"
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ:

   | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
   |-----------|----------|
   | `vkid_enabled` | ‚úÖ –í–∫–ª—é—á–∏—Ç—å |
   | `vkid_client_id` | –í–∞—à VK App ID |
   | `vkid_client_secret` | –í–∞—à VK –ó–∞—â–∏—â—ë–Ω–Ω—ã–π –∫–ª—é—á |
   | `vkid_scope` | `vkid.personal_info email phone` |

4. **–û—Ç–∫–ª—é—á–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** (–µ—Å–ª–∏ –≤–∏–¥–Ω—ã):
   - –°–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É —Å `vk_auth_enabled`

### –®–∞–≥ 4: –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–∏

–£ –≤–∞—Å –µ—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:

#### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∏–≥—Ä–∏—Ä—É—é—Ç** –ø—Ä–∏ –≤—Ö–æ–¥–µ:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ VK ID"
2. –ü—Ä–æ—Ö–æ–¥–∏—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ VK
3. –ü–ª–∞–≥–∏–Ω –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –∞–∫–∫–∞—É–Ω—Ç `vkontakte`
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞ `vkid`
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç –±–µ–∑ –ø—Ä–æ–±–ª–µ–º

**–ü–ª—é—Å—ã**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã, –Ω—É–ª–µ–≤–æ–π –¥–∞—É–Ω—Ç–∞–π–º
**–ú–∏–Ω—É—Å—ã**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–∏–≥—Ä–∏—Ä—É—é—Ç –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ (–ø–æ –º–µ—Ä–µ –≤—Ö–æ–¥–∞)

#### –í–∞—Ä–∏–∞–Ω—Ç –ë: –ú–∞—Å—Å–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

–ú–∏–≥—Ä–∏—Ä—É–π—Ç–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å—Ä–∞–∑—É —Å –ø–æ–º–æ—â—å—é rake –∑–∞–¥–∞—á–∏:

```bash
cd /var/discourse
./launcher enter app
rake vkid:migrate_users
```

**–í—ã–≤–æ–¥:**
```
–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è VK ID...
============================================================
–ù–∞–π–¥–µ–Ω–æ 1523 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏.

..................................................
..................................................
(–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è...)

============================================================
–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
‚úÖ –£—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ: 1523 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

**–ü–ª—é—Å—ã**: –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å—Ä–∞–∑—É
**–ú–∏–Ω—É—Å—ã**: –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –ø–æ SSH/–∫–æ–Ω—Å–æ–ª–∏

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
cd /var/discourse
./launcher enter app
rake vkid:migration_status
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥ (–ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏):**
```
–°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏ VK ID
============================================================
–°—Ç–∞—Ä—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (vkontakte): 0 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
–ù–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (vkid):      1523 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ vkid.
```

### –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à —Å–∞–π—Ç Discourse –≤ **—Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ**
2. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏"
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "—á–µ—Ä–µ–∑ VK ID"
4. –í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ VK ID (id.vk.ru)
5. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "redirect_uri_mismatch"

**–ü—Ä–∏—á–∏–Ω–∞**: Callback URL –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è VK.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è VK –Ω–∞ https://id.vk.com
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ redirect URI —Ç–æ—á–Ω–æ:
   ```
   https://–≤–∞—à-—Å–∞–π—Ç.com/auth/vkid/callback
   ```
3. –°–æ–≤–ø–∞–¥–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª http/https
4. –ù–µ—Ç –∑–∞–≤–µ—Ä—à–∞—é—â–µ–≥–æ —Å–ª–µ—à–∞

### –ü—Ä–æ–±–ª–µ–º–∞: "invalid_request: code_verifier is missing"

**–ü—Ä–∏—á–∏–Ω–∞**: PKCE –Ω–µ –≤–∫–ª—é—á—ë–Ω –¥–æ–ª–∂–Ω—ã–º –æ–±—Ä–∞–∑–æ–º.

**–†–µ—à–µ–Ω–∏–µ**:
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–ª–∞–≥–∏–Ω v2.0+ (`git log` –≤ –ø–∞–ø–∫–µ –ø–ª–∞–≥–∏–Ω–∞)
- –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ Discourse: `./launcher rebuild app`
- –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à/–∫—É–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏

**–ü—Ä–∏—á–∏–Ω–∞**: UserAssociatedAccount –≤—Å—ë –µ—â—ë —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä.

**–†–µ—à–µ–Ω–∏–µ**:
–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–¥–∞—á—É –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
rake vkid:migrate_users
```

–ò–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ.

### –ü—Ä–æ–±–ª–µ–º–∞: Email –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞**: –°–∫–æ—É–ø email –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `vkid_scope` –≤–∫–ª—é—á–∞–µ—Ç `email`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ VK –≤–∫–ª—é—á–µ–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ email
3. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å email –≤ –∞–∫–∫–∞—É–Ω—Ç–µ VK

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –¥–≤–µ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ VK

**–ü—Ä–∏—á–∏–Ω–∞**: –í–∫–ª—é—á–µ–Ω—ã –∏ —Å—Ç–∞—Ä—ã–µ, –∏ –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

**–†–µ—à–µ–Ω–∏–µ**:
1. –ê–¥–º–∏–Ω ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –í—Ö–æ–¥
2. –°–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É —Å `vk_auth_enabled` (—Å—Ç–∞—Ä–∞—è)
3. –û—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ `vkid_enabled` –≤–∫–ª—é—á—ë–Ω–Ω–æ–π

## –û—Ç–∫–∞—Ç (—Ç–æ–ª—å–∫–æ –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö)

–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–º—É –ø–ª–∞–≥–∏–Ω—É:

```bash
cd /var/discourse
./launcher enter app
rake vkid:rollback_migration
exit
./launcher rebuild app
```

–ó–∞—Ç–µ–º:
1. –û—Ç–∫–ª—é—á–∏—Ç–µ `vkid_enabled`
2. –í–∫–ª—é—á–∏—Ç–µ `vk_auth_enabled`
3. –í–µ—Ä–Ω–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ VK redirect URI –Ω–∞ `/vkontakte/callback`

**–í–Ω–∏–º–∞–Ω–∏–µ**: –û—Ç–∫–∞—Ç—ã–≤–∞–π—Ç–µ—Å—å —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ. VK ID - —ç—Ç–æ –±—É–¥—É—â–µ–µ.

## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ VK ID
- [ ] –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ VK ID
- [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ VK –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å–≤–æ–∏ –∞–∫–∫–∞—É–Ω—Ç—ã (–Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è)
- [ ] –ê–≤–∞—Ç–∞—Ä/email —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å VK ID

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:
```bash
tail -f /var/discourse/shared/standalone/log/rails/production.log | grep "VK ID"
```

## –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### –ù—É–∂–Ω–æ –ª–∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?

**–ù–µ—Ç**. –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–∑—Ä–∞—á–Ω–∞:
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –ù–∞–∂–∏–º–∞—é—Ç "VK ID", –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∏–≥—Ä–∏—Ä—É—é—Ç, –≤—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –ü—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å VK ID
- –ù–∏–∫–∞–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### –ë—É–¥—É—Ç –ª–∏ –ø–æ—Ç–µ—Ä—è–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?

**–ù–µ—Ç**. –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:
- –ê–∫–∫–∞—É–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–æ—Å—Ç—ã/—Ç–µ–º—ã
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏
- –í—Å–µ —Å–≤—è–∑–∏

–ò–∑–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `provider_name`: `vkontakte` ‚Üí `vkid`

### –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑?

**–î–∞**. –ú–∏–≥—Ä–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞:
- –£–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –î—É–±–ª–∏—Ä—É—é—â–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å UserAssociatedAccount?

```ruby
# –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏
UserAssociatedAccount.find(123)
# => provider_name: "vkontakte", provider_uid: "12345"

# –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
UserAssociatedAccount.find(123)
# => provider_name: "vkid", provider_uid: "12345"
```

–ò–∑–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `provider_name`. –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç—Ä–æ–Ω—É—Ç—ã.

### –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω–∏–º–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è?

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ (–¥–Ω–∏/–Ω–µ–¥–µ–ª–∏ –ø–æ –º–µ—Ä–µ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
**–ú–∞—Å—Å–æ–≤–∞—è rake –∑–∞–¥–∞—á–∞**:
- 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ~2 —Å–µ–∫—É–Ω–¥—ã
- 1,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ~10 —Å–µ–∫—É–Ω–¥
- 10,000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ~100 —Å–µ–∫—É–Ω–¥

–û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ! –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π?

- **–§–æ—Ä—É–º**: https://meta.discourse.org/t/vk-com-login-vkontakte/12987
- **–ü—Ä–æ–±–ª–µ–º—ã**: https://github.com/discourse/discourse-vk-auth/issues
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è VK ID**: https://id.vk.ru/about/business/go/docs

## –ò—Å—Ç–æ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É –≤–∞—Å –±—É–¥–µ—Ç:

‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π OAuth 2.1 —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é PKCE
‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π VK ID (–Ω–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π VK OAuth)
‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚úÖ –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VK ID! üöÄ
